<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>12格動物棋</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: url("cat.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    #turnIndicator {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
      padding: 5px 15px;
      border-radius: 8px;
      background: rgba(255,255,255,0.8);
    }
    #game { display: flex; gap: 20px; }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      grid-template-rows: repeat(4, 80px);
      gap: 2px;
      background: #333;
      padding: 10px;
      border-radius: 10px;
    }
    .cell {
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      border-radius: 8px;
      position: relative;
    }
    .piece {
      width: 70px;
      height: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.3s, opacity 0.3s;
    }
    .p1 { background: #ff9999; }
    .p2 { background: #9999ff; }
    .inactive { opacity: 0.4; }   /* 淡化非當前玩家 */
    .highlight { outline: 3px solid yellow; }
    #capturedP1, #capturedP2 {
      display: flex; flex-direction: column; gap: 5px;
    }
    /* 升變動畫 */
    .promote {
      animation: promoteAnim 0.6s ease-out;
    }
    @keyframes promoteAnim {
      0% { transform: scale(1); background: gold; }
      50% { transform: scale(1.5); background: orange; }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div id="turnIndicator">玩家1回合</div>
  <div id="game">
    <div id="capturedP1"></div>
    <div id="board"></div>
    <div id="capturedP2"></div>
  </div>

  <script>
    const board=document.getElementById("board");
    const capturedP1=document.getElementById("capturedP1");
    const capturedP2=document.getElementById("capturedP2");
    const turnIndicator=document.getElementById("turnIndicator");

    const promoteSound=new Audio("promote.mp3");

    const rows=4,cols=3;
    let currentPlayer=1;
    let selected=null;
    let isDropMode=false;

    const piecesDef={
      J:{name:"將",moves:[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]},
      C:{name:"車",moves:[[1,0],[-1,0],[0,1],[0,-1]]},
      X:{name:"象",moves:[[1,1],[1,-1],[-1,1],[-1,-1]]},
      B:{name:"兵",moves:[[1,0]]},
      G:{name:"吉",moves:[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1]]}
    };

    let boardState=Array(rows).fill(null).map(()=>Array(cols).fill(null));

    function initBoard(){
      boardState[0][0]={player:2,type:"C"};
      boardState[0][1]={player:2,type:"J"};
      boardState[0][2]={player:2,type:"X"};
      boardState[1][1]={player:2,type:"B"};
      boardState[2][1]={player:1,type:"B"};
      boardState[3][0]={player:1,type:"X"};
      boardState[3][1]={player:1,type:"J"};
      boardState[3][2]={player:1,type:"C"};
    }

    function renderBoard(){
      board.innerHTML="";
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cell=document.createElement("div");
          cell.className="cell";
          cell.dataset.row=r;
          cell.dataset.col=c;
          let p=boardState[r][c];
          if(p){
            const div=document.createElement("div");
            div.className=`piece p${p.player}`;
            if(p.player!==currentPlayer) div.classList.add("inactive"); // 淡化非當前玩家
            div.textContent=piecesDef[p.type].name;
            div.dataset.player=p.player;
            div.dataset.type=p.type;
            cell.appendChild(div);
          }
          board.appendChild(cell);
        }
      }
      updateTurnUI();
    }

    function updateTurnUI(){
      turnIndicator.textContent=`玩家${currentPlayer}回合`;
      turnIndicator.style.background=currentPlayer===1?"rgba(255,150,150,0.8)":"rgba(150,150,255,0.8)";
    }

    function clearHighlights(){document.querySelectorAll(".cell").forEach(c=>c.classList.remove("highlight"));}

    function showMoves(r,c,piece){
      clearHighlights();
      let dirs=piecesDef[piece.type].moves;
      dirs.forEach(([dr,dc])=>{
        let nr=piece.player===1?r-dr:r+dr;
        let nc=c+dc;
        if(nr>=0 && nr<rows && nc>=0 && nc<cols){
          let t=boardState[nr][nc];
          if(!t||t.player!==piece.player)document.querySelector(`.cell[data-row="${nr}"][data-col="${nc}"]`).classList.add("highlight");
        }
      });
    }

    function showDropPositions(player){
      clearHighlights();
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(player===1 && r>=2 && !boardState[r][c]) document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`).classList.add("highlight");
          if(player===2 && r<=1 && !boardState[r][c]) document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`).classList.add("highlight");
        }
      }
    }

    function switchPlayer(){currentPlayer=currentPlayer===1?2:1;clearHighlights();selected=null;isDropMode=false;renderBoard();}

    board.addEventListener("click",e=>{
      const cell=e.target.closest(".cell");
      if(!cell)return;
      let r=+cell.dataset.row,c=+cell.dataset.col;

      if(isDropMode && !boardState[r][c]){
        if((currentPlayer===1 && r>=2)||(currentPlayer===2 && r<=1)){
          boardState[r][c]={player:currentPlayer,type:selected.type};
          selected.element.remove();
          switchPlayer();
        }
        return;
      }

      let piece=boardState[r][c];
      if(piece && piece.player===currentPlayer){
        selected=piece;selected.row=r;selected.col=c;
        showMoves(r,c,piece);
      } else if(cell.classList.contains("highlight")){
        let target=boardState[r][c];
        if(target){
          if(target.type==="J"){alert(`玩家${currentPlayer}獲勝!`);}
          addCaptured({...target,player:currentPlayer});
        }
        boardState[r][c]=selected;
        boardState[selected.row][selected.col]=null;

        if(selected.type==="B"){
          if((selected.player===1 && r===0)||(selected.player===2 && r===rows-1)){
            boardState[r][c].type="G";
            setTimeout(()=>{
              let promotedCell=document.querySelector(`.cell[data-row="${r}"][data-col="${c}"] .piece`);
              if(promotedCell){
                promotedCell.classList.add("promote");
                promoteSound.play().catch(()=>{});
              }
            },50);
          }
        }
        switchPlayer();
      }
    });

    function addCaptured(piece){
      if(piece.type==="G")piece.type="B";
      const div=document.createElement("div");
      div.className=`piece p${piece.player}`;
      div.textContent=piecesDef[piece.type].name;
      div.dataset.player=piece.player;
      div.dataset.type=piece.type;
      div.onclick=()=>{
        if(piece.player===currentPlayer){
          selected={player:piece.player,type:piece.type,element:div};
          isDropMode=true;
          showDropPositions(currentPlayer);
        }
      };
      if(piece.player===1)capturedP1.appendChild(div); else capturedP2.appendChild(div);
    }

    initBoard();renderBoard();
  </script>
</body>
</html>
