<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>12格動物棋</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  height: 100vh; margin: 0;
  background: url("cat.jpg") no-repeat center center fixed;
  background-size: cover;
  font-family: "Microsoft JhengHei", sans-serif;
  position: relative; overflow: hidden;
}
body::before {
  content:""; position:fixed; top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px); z-index:0;
  pointer-events: none;
}
#topBar {
  display:flex; justify-content:space-between; align-items:center;
  width:95%; max-width:500px; margin-bottom:10px; gap:10px;
  position:relative; z-index:1;
}
#visitorBadge img { height:24px; max-height:24px; margin-right:5px; vertical-align:middle; }
#turnIndicator {
  font-size:20px; font-weight:bold; padding:6px 15px;
  border-radius:8px; background: rgba(255,255,255,0.8);
  flex:1; text-align:center;
}
button {
  padding:8px 14px; border:none; border-radius:8px;
  font-weight:bold; cursor:pointer; transition:background 0.2s;
  position:relative; z-index:1;
}
#resetBtn { background:#ffcc66; } #resetBtn:hover { background:#ffaa33; }
#undoBtn { background:#99ccff; } #undoBtn:hover { background:#66aaff; }

#game {
  display:flex; gap:10px; justify-content:center; position:relative; z-index:1;
  align-items: flex-start;
}
.board-container {
  display:grid;
  grid-template-columns:repeat(3, min(15vw, 80px));
  grid-template-rows:repeat(4, min(15vw, 80px));
  gap:2px; background:#333; padding:5px; border-radius:10px; position:relative;
}
.cell {
  width:100%; height:100%; background: rgba(255,255,255,0.7);
  display:flex; justify-content:center; align-items:center;
  font-size:1.2em; border-radius:8px; position:relative;
}
.piece {
  width:100%; height:100%; display:flex; justify-content:center; align-items:center;
  border-radius:8px; font-weight:bold; cursor:pointer;
  user-select:none;
  box-shadow: none;
  outline: none;
}
.p1 { background:#ff9999; } .p2 { background:#9999ff; }
.highlight {
  outline: none;
  border: 2px solid yellow;
}
#capturedP1, #capturedP2 {
  display:flex; flex-direction: column; gap:2px;
  justify-content: flex-start; align-items: center;
}
#capturedP1 .piece, #capturedP2 .piece {
  width: calc(min(15vw, 80px));
  height: calc(min(15vw, 80px));
}

@media (max-width:600px){
  .board-container { grid-template-columns:repeat(3,min(20vw,60px)); grid-template-rows:repeat(4,min(20vw,60px)); }
  .cell{ font-size:1em; } .piece{ font-size:0.9em; }
  #turnIndicator{ font-size:18px; } button{ padding:10px 16px; font-size:16px; }
  #capturedP1 .piece, #capturedP2 .piece { width: calc(min(20vw, 60px)); height: calc(min(20vw, 60px)); }
}
</style>
</head>
<body>
<div id="topBar">
  <div id="visitorBadge">
    <img src="https://visitor-badge.laobi.icu/badge?page_id=JiangGray.12" alt="瀏覽人數">
  </div>
  <div id="turnIndicator">玩家1回合</div>
  <button id="undoBtn">悔棋</button>
  <button id="resetBtn">重新開始</button>
</div>
<div id="game">
  <div id="capturedP1"></div>
  <div class="board-container" id="board"></div>
  <div id="capturedP2"></div>
</div>

<script>
const board=document.getElementById("board");
const capturedP1=document.getElementById("capturedP1");
const capturedP2=document.getElementById("capturedP2");
const turnIndicator=document.getElementById("turnIndicator");
const resetBtn=document.getElementById("resetBtn");
const undoBtn=document.getElementById("undoBtn");

const rows=4,cols=3;
let currentPlayer=1,selected=null,isDropMode=false;
const piecesDef={
  J:{name:"將",moves:[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]},
  C:{name:"車",moves:[[1,0],[-1,0],[0,1],[0,-1]]},
  X:{name:"象",moves:[[1,1],[1,-1],[-1,1],[-1,-1]]},
  B:{name:"兵",moves:[[1,0]]},
  G:{name:"雞",moves:[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1]]}
};
let boardState,history=[];

function cloneState(){ 
  return { 
    board: JSON.parse(JSON.stringify(boardState)), 
    player: currentPlayer, 
    capturedP1: capturedP1.innerHTML, 
    capturedP2: capturedP2.innerHTML 
  }; 
}

function restoreState(state){
  boardState=JSON.parse(JSON.stringify(state.board));
  capturedP1.innerHTML=state.capturedP1;
  capturedP2.innerHTML=state.capturedP2;
  selected=null; isDropMode=false;

  // 修正悔棋後玩家順序
  currentPlayer = state.player===1 ? 2 : 1;

  renderBoard();
}

function initBoard(){
  boardState=Array(rows).fill(null).map(()=>Array(cols).fill(null));
  boardState[0][0]={player:2,type:"C"}; boardState[0][1]={player:2,type:"J"}; boardState[0][2]={player:2,type:"X"};
  boardState[1][1]={player:2,type:"B"}; boardState[2][1]={player:1,type:"B"};
  boardState[3][0]={player:1,type:"X"}; boardState[3][1]={player:1,type:"J"}; boardState[3][2]={player:1,type:"C"};
  currentPlayer=1; selected=null; isDropMode=false;
  capturedP1.innerHTML=""; capturedP2.innerHTML=""; history=[];
  history.push(cloneState());
}

function renderBoard(){
  board.innerHTML="";
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell=document.createElement("div");
      cell.className="cell"; cell.dataset.row=r; cell.dataset.col=c;
      board.appendChild(cell);
      let p=boardState[r][c];
      if(p){
        const div=document.createElement("div");
        div.className=`piece p${p.player}`;
        div.textContent=piecesDef[p.type].name;
        div.dataset.player=p.player; div.dataset.type=p.type;
        cell.appendChild(div);
      }
    }
  }
  updateTurnUI();
}

function updateTurnUI(){
  turnIndicator.textContent=`玩家${currentPlayer}回合`;
  turnIndicator.style.background=currentPlayer===1?"rgba(255,150,150,0.8)":"rgba(150,150,255,0.8)";
}

function clearHighlights(){document.querySelectorAll(".cell").forEach(c=>c.classList.remove("highlight"));}

function showMoves(r,c,piece){
  clearHighlights();
  let dirs=piecesDef[piece.type].moves;
  dirs.forEach(([dr,dc])=>{
    let nr=piece.player===1?r-dr:r+dr, nc=c+dc;
    if(nr>=0 && nr<rows && nc>=0 && nc<cols){
      let t=boardState[nr][nc];
      if(!t||t.player!==piece.player)
        document.querySelector(`.cell[data-row="${nr}"][data-col="${nc}"]`).classList.add("highlight");
    }
  });
}

function showDropPositions(player){
  clearHighlights();
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    if((player===1&&r>=2&&!boardState[r][c]) || (player===2&&r<=1&&!boardState[r][c]))
      document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`).classList.add("highlight");
  }
}

function switchPlayer(){ currentPlayer=currentPlayer===1?2:1; clearHighlights(); selected=null; isDropMode=false; renderBoard(); }

board.addEventListener("click",e=>{
  const cell=e.target.closest(".cell"); if(!cell)return;
  let r=+cell.dataset.row,c=+cell.dataset.col;

  if(isDropMode && !boardState[r][c]){
    if((currentPlayer===1 && r>=2)||(currentPlayer===2 && r<=1)){
      boardState[r][c]={player:currentPlayer,type:selected.type};
      selected.element.remove();
      history.push(cloneState());
      switchPlayer();
    }
    return;
  }

  let piece=boardState[r][c];
  if(piece && piece.player===currentPlayer){
    selected=piece; selected.row=r; selected.col=c;
    showMoves(r,c,piece);
  } else if(cell.classList.contains("highlight")){
    let target = boardState[r][c];
    if(target){
      if(target.type === "J"){
        alert(`玩家${currentPlayer}獲勝!`);
      }
      addCaptured({...target});
    }

    boardState[r][c] = selected;
    boardState[selected.row][selected.col] = null;

    if(selected.type === "B"){
      if((selected.player===1 && r===0) || (selected.player===2 && r===rows-1)){
        boardState[r][c].type = "G";
      }
    }

    history.push(cloneState());
    switchPlayer();
  }
});

function addCaptured(piece){
  const div = document.createElement("div");
  div.className = `piece p${piece.player}`;
  div.textContent = piecesDef[piece.type].name;
  div.dataset.player = piece.player;
  div.dataset.type = piece.type;
  div.onclick = ()=>{
    if(piece.player===currentPlayer){
      selected = {player: piece.player, type: piece.type, element: div};
      isDropMode = true;
      showDropPositions(currentPlayer);
    }
  };
  if(piece.player===1) capturedP1.appendChild(div);
  else capturedP2.appendChild(div);
}

resetBtn.onclick = ()=>{ initBoard(); renderBoard(); };
undoBtn.onclick = ()=>{
  if(history.length>1){
    history.pop();
    restoreState(history[history.length-1]);
  }
};

initBoard();
renderBoard();
</script>
</body>
</html>
